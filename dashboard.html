<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FuggaFod — Home</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --glass-bg: rgba(255,255,255,0.06);
    --accent: #00ffea;
    --danger: #ff4b2b;
    --card-radius: 18px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{
    background: linear-gradient(135deg,#0f1226 0%, #22113a 45%, #40224f 100%);
    color:#fff;
    display:flex;
    justify-content:center;
    padding:28px;
    box-sizing:border-box;
  }

  .container{
    width:100%;
    max-width:980px;
  }

  /* Header */
  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:18px;
  }

  .leftHeader, .rightHeader{
    display:flex;
    align-items:center;
    gap:12px;
  }

  .tokens-card{
    background:var(--glass-bg);
    backdrop-filter: blur(6px);
    padding:10px 14px;
    border-radius:14px;
    display:flex;
    align-items:center;
    gap:10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  .tokens-card img{ width:20px; height:20px; }
  .tokens-card .label{ font-weight:600; font-size:14px; opacity:0.9; }
  .tokens-card .value{ font-weight:700; font-size:18px; color:var(--accent); }

  /* Spin small button top-right */
  .spin-small-btn{
    background:linear-gradient(180deg,#151515,#0f0f10);
    border-radius:12px;
    padding:8px 12px;
    display:flex;
    gap:10px;
    align-items:center;
    cursor:pointer;
    border:1px solid rgba(255,255,255,0.04);
    box-shadow:0 8px 20px rgba(0,0,0,0.6);
  }
  .spin-small-btn .dot{ width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow:0 0 8px var(--accent); }
  .spin-small-btn span{ font-weight:700; font-size:13px; color:#fff; }

  /* Main content card */
  .main-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius: 18px;
    padding:22px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  }

  .top-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:20px;
    flex-wrap:wrap;
  }

  /* Spin & Win area (top-right when expanded) */
  .spin-area{
    width:320px;
    min-height:110px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }

  /* Games area */
  .games-area{
    margin-top:18px;
    display:flex;
    gap:14px;
    flex-wrap:wrap;
  }

  .game-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;
    padding:14px;
    width:220px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.55);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }
  .game-card img{ width:110px; height:110px; border-radius:12px; object-fit:cover; }
  .game-card button{
    padding:10px 16px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    background:var(--accent);
    color:#061018;
    font-weight:700;
  }

  /* Empty area placeholder */
  .empty-area{
    margin-top:18px;
    min-height:160px;
    border-radius:12px;
    background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    display:flex;
    align-items:center;
    justify-content:center;
    color:rgba(255,255,255,0.18);
    font-size:14px;
  }

  /* Modal overlay (for spin wheel and for pay) */
  .overlay{
    position:fixed; inset:0; display:flex; justify-content:center; align-items:center;
    background: rgba(0,0,0,0.65); z-index:2000; padding:20px; box-sizing:border-box;
  }
  .modal{
    width:100%; max-width:520px; background:#0f1114; padding:18px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.7);
    display:flex; flex-direction:column; align-items:center; gap:12px; position:relative;
  }

  /* Wheel container */
  .wheel-wrap{ position:relative; width:320px; height:320px; display:flex; justify-content:center; align-items:center; }
  .wheel-rotator{ width:300px; height:300px; border-radius:50%; transform:rotate(0deg); transition: transform 10s cubic-bezier(.17,.67,.83,.67); will-change:transform; }
  canvas#wheelCanvas{ width:300px; height:300px; border-radius:50%; display:block; }

  /* Nail indicator */
  .nail {
    position:absolute;
    top:calc(50% - 160px); /* above the wheel */
    left:50%;
    transform:translateX(-50%);
    width:0;height:0;
    border-left:12px solid transparent;
    border-right:12px solid transparent;
    border-bottom:18px solid #ffd700;
    filter:drop-shadow(0 4px 8px rgba(0,0,0,0.6));
    z-index:30;
  }

  .spin-actions{ display:flex; gap:10px; align-items:center; margin-top:6px;}
  .spin-actions button{ padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:700;}
  .spin-now{ background:var(--accent); color:#041014;}
  .close-modal{ background:#222; color:#fff; }

  .result-text{ margin-top:6px; font-weight:700; font-size:16px; color:#ffd700; min-height:22px; text-align:center; }

  /* small timer below spin button on header */
  .spin-timer-small{ font-size:13px; color:#ffd966; opacity:0.95; font-weight:600; margin-left:8px; }

  /* responsive */
  @media (max-width:720px){
    .spin-area{ width:100%; order:2; }
    .game-card{ width:46%; }
  }
</style>
</head>
<body>
  <div class="container">

    <!-- HEADER -->
    <div class="header">
      <div class="leftHeader">
        <div class="tokens-card" title="Your tokens">
          <img src="images/token_icon.png" alt="token">
          <div>
            <div class="label">Tokens</div>
            <div class="value" id="tokensValue">0</div>
          </div>
        </div>
      </div>

      <div class="rightHeader">
        <div id="spinSmallBtn" class="spin-small-btn" title="Spin & Win">
          <div class="dot"></div>
          <span>Spin & Win</span>
        </div>
        <div id="headerSpinTimer" class="spin-timer-small" aria-hidden="true"></div>
      </div>
    </div>

    <!-- MAIN CARD (holds spin area on right and games on left) -->
    <div class="main-card">
      <div class="top-row">
        <!-- Left area (games) -->
        <div style="flex:1; min-width:260px;">
          <h3 style="margin:0 0 12px 0;">Games</h3>

          <div class="games-area">
            <!-- FuggaFod -->
            <div class="game-card">
              <img src="images/ff_icon.png" alt="FuggaFod">
              <div style="font-weight:700;">FuggaFod</div>
              <div style="font-size:13px; color:rgba(255,255,255,0.7);">Entry fee: <strong>25 tokens</strong></div>
              <button id="enterGameBtn">Play</button>
            </div>

            <!-- you can add more cards here -->
          </div>
        </div>

        <!-- Right area (compact spin info + open) -->
        <div class="spin-area">
          <div style="font-weight:700; font-size:15px; opacity:0.95;">Spin & Win</div>
          <div style="font-size:13px; color:rgba(255,255,255,0.7); text-align:center;">Tap to open the wheel. Win tokens or messages — random each time.</div>
          <div style="margin-top:8px;">
            <button id="openSpinInline" class="spin-now" style="padding:8px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700;">Open Wheel</button>
          </div>
          <div class="result-text" id="miniSpinResult">Next spin status will appear here</div>
        </div>
      </div>

      <div class="empty-area">This space is empty for now — perfect for future features or leaderboard.</div>
    </div>
  </div>

  <!-- SPIN MODAL -->
  <div id="spinModal" class="overlay" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="spinTitle">
      <div id="spinTitle" style="font-weight:800; color:var(--accent);">Spin & Win</div>
      <div style="font-size:13px; color:rgba(255,255,255,0.8);">Cooldown: 4 hours • Spin duration 10s</div>

      <div class="wheel-wrap">
        <div class="nail" aria-hidden="true"></div>
        <div class="wheel-rotator" id="wheelRotator">
          <canvas id="wheelCanvas" width="600" height="600"></canvas>
        </div>
      </div>

      <div class="spin-actions">
        <button id="spinNowBtn" class="spin-now">Spin Now</button>
        <button id="closeSpinBtn" class="close-modal">Close</button>
      </div>

      <div class="result-text" id="spinResult"> </div>
    </div>
  </div>

  <!-- ENTRY PAYMENT MODAL (for FuggaFod) -->
  <div id="entryModal" class="overlay" style="display:none;">
    <div class="modal">
      <div style="font-weight:800; color:var(--accent);">Enter FuggaFod</div>
      <div style="font-size:14px; color:rgba(255,255,255,0.85);">Pay <strong>25 tokens</strong> to enter the game?</div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button id="entryYes" style="background:var(--accent); color:#041014; padding:10px 14px; border-radius:10px; border:none; font-weight:700;">Pay & Enter</button>
        <button id="entryNo" style="background:#222; color:#fff; padding:10px 14px; border-radius:10px; border:none; font-weight:700;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  // ====== CONFIG ======
  const firebaseConfig = {
    apiKey: "AIzaSyDSeRdpupEQcEwo_q54umdAU4WHeCoPTGs",
    authDomain: "ff-game-login.firebaseapp.com",
    databaseURL: "https://ff-game-login-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ff-game-login",
    storageBucket: "ff-game-login.firebasestorage.app",
    messagingSenderId: "318341155193",
    appId: "1:318341155193:web:d56d80dd691568b2cfc7a8",
    measurementId: "G-0H5SM37VLZ"
  };
  firebase.initializeApp(firebaseConfig);

  // ====== ELEMENTS ======
  const tokensValue = document.getElementById('tokensValue');
  const userId = localStorage.getItem('userId') || 'guest_user'; // ensure some id exists
  const username = localStorage.getItem('username') || 'Player';

  // subscribe tokens
  firebase.database().ref('users/' + userId + '/tokens').on('value', snap => {
    const v = snap.val() || 0;
    tokensValue.textContent = v;
  });

  // ===== SPIN SETUP =====
  const segments = [
    {label:"500 Tokens", reward:500},
    {label:"Better luck next time", reward:0},
    {label:"200 Tokens", reward:200},
    {label:"Oops sorry!", reward:0},
    {label:"100 Tokens", reward:100},
    {label:"Try later", reward:0}
  ];
  const colors = ["#FF4B2B","#FF416C","#6A11CB","#2575FC","#00FFA3","#FFD700"];
  const segCount = segments.length;
  const segmentDeg = 360 / segCount;

  // Canvas drawing (draw wheel once)
  const canvas = document.getElementById('wheelCanvas');
  const ctx = canvas.getContext('2d');
  const cx = canvas.width/2, cy = canvas.height/2, radius = Math.min(cx,cy) - 4;
  function drawWheel(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // start angle at -90deg so top is first segment center offset
    const startOffset = -Math.PI/2;
    for(let i=0;i<segCount;i++){
      const startA = startOffset + i*(2*Math.PI/segCount);
      const endA = startOffset + (i+1)*(2*Math.PI/segCount);
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,radius,startA,endA);
      ctx.closePath();
      ctx.fillStyle = colors[i%colors.length];
      ctx.fill();

      // labels
      ctx.save();
      // place text roughly halfway of arc
      const midA = (startA + endA)/2;
      ctx.translate(cx + Math.cos(midA)*(radius*0.6), cy + Math.sin(midA)*(radius*0.6));
      ctx.rotate(midA + Math.PI/2);
      ctx.fillStyle = "#0b0b0b";
      ctx.font = "bold 20px Arial";
      ctx.textAlign = "center";
      // use shorter label text if too long
      ctx.fillText(segments[i].label, 0, 0);
      ctx.restore();
    }
    // center circle
    ctx.beginPath();
    ctx.arc(cx,cy,48,0,Math.PI*2);
    ctx.fillStyle = "#0b0b0b";
    ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.font = "bold 16px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SPIN", cx, cy + 6);
  }
  drawWheel();

  // rotation control: rotate the .wheel-rotator element
  const wheelRotator = document.getElementById('wheelRotator');
  const spinModal = document.getElementById('spinModal');
  const spinSmallBtn = document.getElementById('spinSmallBtn');
  const openSpinInline = document.getElementById('openSpinInline');
  const spinNowBtn = document.getElementById('spinNowBtn');
  const closeSpinBtn = document.getElementById('closeSpinBtn');
  const spinResult = document.getElementById('spinResult');
  const miniSpinResult = document.getElementById('miniSpinResult');
  const headerSpinTimer = document.getElementById('headerSpinTimer');

  // cooldown tracking in DB
  const lastSpinRef = firebase.database().ref('users/' + userId + '/lastSpinTime');

  // helper to format remaining time
  function formatTimeMs(ms){
    if(ms<=0) return "0s";
    const s = Math.floor(ms/1000)%60;
    const m = Math.floor(ms/60000)%60;
    const h = Math.floor(ms/3600000);
    return `${h}h ${m}m ${s}s`;
  }

  // update small header timer and mini result
  function updateSpinTimerDisplay(lastSpin){
    const now = Date.now();
    const next = (lastSpin || 0) + 4*60*60*1000;
    const remaining = next - now;
    if(remaining <= 0){
      headerSpinTimer.textContent = "Spin ready";
      miniSpinResult.textContent = "You can spin now!";
      spinNowBtn.disabled = false;
    } else {
      headerSpinTimer.textContent = "Next: " + formatTimeMs(remaining);
      miniSpinResult.textContent = "Next spin in: " + formatTimeMs(remaining);
      spinNowBtn.disabled = true;
      // schedule update every 1s
      setTimeout(()=> updateSpinTimerDisplay(lastSpin), 1000);
    }
  }

  // initialize timer on load
  lastSpinRef.once('value').then(snap=>{
    const last = snap.val() || 0;
    updateSpinTimerDisplay(last);
  });

  // open spin modal (two triggers)
  spinSmallBtn.addEventListener('click', ()=> {
    spinModal.style.display = 'flex';
    // update local current status
    lastSpinRef.once('value').then(snap => updateSpinTimerDisplay(snap.val()||0));
  });
  openSpinInline.addEventListener('click', ()=> {
    spinModal.style.display = 'flex';
    lastSpinRef.once('value').then(snap => updateSpinTimerDisplay(snap.val()||0));
  });
  closeSpinBtn.addEventListener('click', ()=> {
    spinModal.style.display = 'none';
    spinResult.textContent = "";
  });

  // spin logic
  let spinning = false;
  spinNowBtn.addEventListener('click', async ()=> {
    if(spinning) return;
    spinning = true;
    spinNowBtn.disabled = true;
    spinResult.textContent = "Spinning...";

    // check cooldown
    const snap = await lastSpinRef.once('value');
    const lastSpin = snap.val() || 0;
    if(Date.now() - lastSpin < 4*60*60*1000){
      // too early
      spinResult.textContent = "You can't spin yet!";
      updateSpinTimerDisplay(lastSpin);
      spinning = false;
      return;
    }

    // pick random winner index
    const winnerIndex = Math.floor(Math.random() * segCount);

    // compute rotation:
    // Our wheel drawing has 0deg pointing to top (-90deg offset applied while drawing).
    // To land winnerIndex under the nail (top), compute angle so the segment center aligns to top.
    // segment i center angle (degrees) measured clockwise from top = i * segmentDeg + segmentDeg/2
    const rotations = Math.floor(Math.random()*3) + 6; // 6..8 full rotations for nice feel
    const targetDeg = rotations*360 + (winnerIndex * segmentDeg) + (segmentDeg/2);

    // Apply negative because CSS rotate rotates clockwise positive; we want wheel to spin clockwise
    // but our mapping treats segment positions accordingly — this works reasonably because random.
    wheelRotator.style.transition = 'transform 10s cubic-bezier(.17,.67,.83,.67)';
    wheelRotator.style.transform = `rotate(${targetDeg}deg)`;

    // after 10s (spin duration) handle result
    const spinDuration = 10000; // 10 seconds
    setTimeout(async ()=> {
      // stop transition to allow future immediate set
      wheelRotator.style.transition = 'none';
      // normalize rotation to avoid huge transforms accumulation
      const finalRotation = targetDeg % 360;
      wheelRotator.style.transform = `rotate(${finalRotation}deg)`;

      // determine winner index again robustly based on finalRotation
      // convert finalRotation deg to index: (finalRotation - segmentDeg/2) / segmentDeg floor etc.
      // Because we rotated wheel by targetDeg degrees, the top corresponds to angle = targetDeg mod 360.
      // compute landed index:
      const landedIndex = (Math.floor(((finalRotation + 360) % 360) / segmentDeg)) % segCount;
      // But because of drawing offset (-90deg) and label placement, our mapping may shift.
      // To ensure we match the earlier winnerIndex, we will prefer the initial winnerIndex used.
      // Use winnerIndex as the actual result (random).
      const result = segments[winnerIndex];

      // show result text
      if(result.reward > 0){
        spinResult.textContent = `You won: ${result.reward} tokens! 🎉`;
      } else {
        spinResult.textContent = result.label;
      }
      miniSpinResult.textContent = spinResult.textContent;

      // if reward > 0, update Firebase tokens
      if(result.reward > 0){
        const userRef = firebase.database().ref('users/' + userId);
        const snapUser = await userRef.once('value');
        let current = snapUser.val() && snapUser.val().tokens ? snapUser.val().tokens : 0;
        current += result.reward;
        await userRef.update({ tokens: current });
      }

      // update lastSpinTime
      await lastSpinRef.set(Date.now());
      updateSpinTimerDisplay(Date.now());

      // allow next spins after cooldown (but disable immediate)
      setTimeout(()=> {
        spinning = false;
        spinNowBtn.disabled = true; // will be re-enabled by timer when cooldown over
      }, 500);

    }, spinDuration + 60); // small buffer
  });

  // ===== ENTRY (FuggaFod) PAY FLOW =====
  const enterGameBtn = document.getElementById('enterGameBtn');
  const entryModal = document.getElementById('entryModal');
  const entryYes = document.getElementById('entryYes');
  const entryNo = document.getElementById('entryNo');
  const loadingOverlay = null; // if you want to reuse loading overlay, implement here

  enterGameBtn.addEventListener('click', ()=> {
    entryModal.style.display = 'flex';
  });
  entryNo.addEventListener('click', ()=> {
    entryModal.style.display = 'none';
  });

  entryYes.addEventListener('click', async ()=> {
    // charge 25 tokens
    const fee = 25;
    const userRef = firebase.database().ref('users/' + userId);
    const snap = await userRef.once('value');
    let tokens = snap.val() && snap.val().tokens ? snap.val().tokens : 0;
    if(tokens >= fee){
      tokens -= fee;
      await userRef.update({ tokens: tokens });
      entryModal.style.display = 'none';
      // now enter game (redirect)
      // Make sure FuggaFod.html exists or replace with your game url
      window.location.href = 'FuggaFod.html';
    } else {
      alert('Not enough tokens to enter the game!');
      entryModal.style.display = 'none';
    }
  });

  // small UX: clicking outside modal closes it
  document.querySelectorAll('.overlay').forEach(ov => {
    ov.addEventListener('click', (e)=>{
      if(e.target === ov){
        ov.style.display = 'none';
      }
    });
  });

  // done — nice UX
  </script>
</body>
</html>
